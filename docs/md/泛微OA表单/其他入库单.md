## å…¶ä»–å…¥åº“å•è¯¦è§£
***
### 1.è¡¨å•å­—æ®µ
>ä¸€ä¸ªæµç¨‹çš„åŸºç¡€æ˜¯è¡¨å•ï¼Œè€Œä¸€äº›ä»å¤–éƒ¨æ•°æ®æºè·å–çš„è¡¨å•è¾ƒä¸ºå¤æ‚ï¼Œä»¥å…¶ä»–å…¥åº“å•ä¸ºä¾‹ã€‚
![](https://pictures.darkmoon.top/imgs/202306271558230.png)
#### 1.1 å…¥åº“å•ç±»å‹å­—æ®µ
![](https://pictures.darkmoon.top/imgs/202306271600511.png)
>è¯¥å­—æ®µå¯¹åº”çš„ä¾›åº”é“¾çš„æºç å¦‚ä¸‹
![](https://pictures.darkmoon.top/imgs/202306271602260.png)

è¿™ä¸ªå­—æ®µçš„æƒ…å†µæ˜¯ï¼šè´¦å¥—ä¸åŒæ—¶å¯¹åº”çš„sqlä¸åŒï¼Œé‚£ä¹ˆæœ€å¥½ç”¨è‡ªå®šä¹‰æ¥å£

é¦–å…ˆæ‰“å¼€é¡¹ç›®ï¼Œåœ¨é¡¹ç›®Applicationçš„Serviceæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºOAOtherWarehouseReceiptæ–‡ä»¶å¤¹ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹ä»£è¡¨å…¶ä»–é‡‡è´­å•ä¸šåŠ¡ã€‚

å†™è¯¥å­—æ®µå¯¹åº”çš„è‡ªå®šä¹‰æ¥å£æ‰€éœ€åç«¯çš„ä»£ç ã€‚

```csharp
using SqlSugar;
using System.IO;

namespace Admin.NET.Application.Service.OAOtherWarehouseReceipt;
[ApiDescriptionSettings("å…¶ä»–å…¥åº“å•ä¿¡æ¯")]

//IDynamicApiControllerè¿™ä¸ªæ˜¯furionæ¡†æ¶çš„æ§åˆ¶å™¨æ¥å£
public class OAOtherWarehouseReceiptInfoService:IDynamicApiController
{
    //sqlsugarå®¢æˆ·ç«¯
    ISqlSugarClient db;

    public OAOtherWarehouseReceiptInfoService(ISqlSugarClient db)
    {
        this.db = db;
    }

    [HttpGet]
    //Produces("text/plain")æ³¨è§£ä½œç”¨æ˜¯æ— è§†æ¡†æ¶çš„ç»“æœè¿‡æ»¤å™¨ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªæ–‡æœ¬
    [Produces("text/plain")]
    public async Task<string> bindFBillType(string FaccID)
    {
        string sql = "";
        //å¦‚æœæ˜¯æ˜†å±±è¾¾äºšè´¦å¥—
        if (FaccID == "1008")
        {
            sql = "SELECT FNumber,FName FROM t_Item WHERE FItemClassID  = 3002 AND FDeleted =0 ";
        }
        else if (FaccID == "1003")
        {
            sql = "SELECT FNumber,FName FROM t_Item WHERE FItemClassID  = 3010 AND FDeleted =0 ";
        }
        else
        {
            sql = " SELECT FNumber,FName FROM ICBillType WHERE FID NOT BETWEEN 3 AND 9";
        }

        //è·å–æ•°æ®è¡¨æ ¼
        var dt = await db.AsTenant().GetConnection(FaccID).Ado.GetDataTableAsync(sql);

        //datasã€dataæ˜¯æ³›å¾®è¦æ±‚çš„xmlè·¯å¾„
        dt.DataSet.DataSetName = "datas";
        dt.TableName = "data";

        //è¿™ä¸ªusingä¸èƒ½çœ,æ˜¯using(xxx www = new xxx();){}çš„è¯­æ³•ç³–
        using StringWriter stringWriter = new StringWriter();
        dt.WriteXml(stringWriter);

        return stringWriter.ToString();
    }
}
```

>ä¸‹ä¸€æ­¥è®©æ³›å¾®æœåŠ¡å™¨èƒ½è®¿é—®æœ¬æœºè·‘çš„é¡¹ç›®ã€‚æœ¬åœ°é˜²ç«å¢™è¦æ”¾è¡Œç›¸åº”çš„ç«¯å£ã€‚
![](https://pictures.darkmoon.top/imgs/202306280910009.png)

>å¯åŠ¨æ–¹å¼æœ€å¥½ä»¥admin.net.web.entryæ–¹å¼å¯åŠ¨ï¼Œè¿™æ ·ä¼šå¼¹å‡ºä¸€ä¸ªæ§åˆ¶å°ï¼Œä»æ§åˆ¶å°ä¸­èƒ½çœ‹åˆ°sqlsugarç”Ÿæˆçš„sqlè¯­å¥ï¼Œæ–¹ä¾¿å®¡æŸ¥ã€‚

>ä¸€å¼€å§‹é¡¹ç›®å¯èƒ½æ²¡æœ‰è¿™äº›å¯åŠ¨é¡¹ï¼Œå¦‚æœæ²¡çœ‹åˆ°ï¼Œé‚£ä¹ˆç‚¹å‡»é…ç½®å¯åŠ¨é¡¹ç›®ã€‚
![](https://pictures.darkmoon.top/imgs/202306280917920.png)
é€‰è¯¥é€‰é¡¹ç„¶åç¡®å®šï¼Œå°±èƒ½çœ‹åˆ°ã€‚
![](https://pictures.darkmoon.top/imgs/202306280920990.png)

>æŸ¥çœ‹æ³›å¾®æœåŠ¡å™¨æ˜¯å¦èƒ½è¿æ¥è¯¥ç«¯å£ï¼Œæˆ‘æœ¬åœ°ç«¯å£æ˜¯5555.
![](https://pictures.darkmoon.top/imgs/202306280923334.png)
èƒ½è¿›å»å°±æ˜¯è¿æ¥æˆåŠŸ
![](https://pictures.darkmoon.top/imgs/202306280924361.png)

>ä¸‹ä¸€æ­¥æ³›å¾®åç«¯èœå•é›†æˆä¸­å¿ƒ->æ•°æ®å±•ç°é›†æˆä¸­é…ç½®è‡ªå®šä¹‰æ¥å£ã€‚
åœ¨æ­¤ä¹‹å‰éœ€è¦åŠ å…¥ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºç‰¹æ€§è®©æ¥å£å…è®¸ä»»ä½•äººè®¿é—®ã€‚
![](https://pictures.darkmoon.top/imgs/202306280935973.png)
![](https://pictures.darkmoon.top/imgs/202306280937391.png)

>ç”±äºè¡¨å•ä¸­ç”¨åˆ°çš„è´¦å¥—çš„å€¼æ˜¯æ•°æ®åº“åœ°å€ï¼Œæ‰€ä»¥è¦å°†åœ°å€å’Œfacctidè¿›è¡Œè½¬æ¢ã€‚
è¿™ä¸ªæœåŠ¡åœ¨é‡‡è´­ç”³è¯·å•ä¸­å†™è¿‡äº†ï¼Œè¿™é‡Œç›´æ¥æ³¨å…¥å°±å¥½äº†.
![](https://pictures.darkmoon.top/imgs/202306280951201.png)
è¦å°†ç±»å˜ä¸ºæœåŠ¡ç±»,è¦ä¸ºç±»æŒ‡å®šç”Ÿå‘½å‘¨æœŸ,ä¸€èˆ¬ä¸æ˜¯ç»å¸¸è°ƒç”¨çš„ç”¨ç¬æ€å°±å¯ä»¥äº†.
![](https://pictures.darkmoon.top/imgs/202306280952204.png)
å°†è¯¥ç±»æ³¨å…¥è¿›å…¶ä»–å…¥åº“å•ä¿¡æ¯ç±»ä¸­
![](https://pictures.darkmoon.top/imgs/202306281002204.png)

```csharp
using Admin.NET.Application.Service.OAPurchase;
using Microsoft.AspNetCore.Authorization;
using SqlSugar;
using System.IO;

namespace Admin.NET.Application.Service.OAOtherWarehouseReceipt;
[ApiDescriptionSettings("å…¶ä»–å…¥åº“å•ä¿¡æ¯")]
[AllowAnonymous]

//IDynamicApiControllerè¿™ä¸ªæ˜¯furionæ¡†æ¶çš„æ§åˆ¶å™¨æ¥å£
public class OAOtherWarehouseReceiptInfoService:IDynamicApiController
{
    //sqlsugarå®¢æˆ·ç«¯
    ISqlSugarClient db;

    private readonly OAPurchaseInfoService purchaseInfoService;

    public OAOtherWarehouseReceiptInfoService(ISqlSugarClient db, OAPurchaseInfoService purchaseInfoService)
    {
        this.db = db;
        this.purchaseInfoService = purchaseInfoService;
    }

    [HttpGet]
    [Produces("text/plain")]
    public async Task<string> bindFBillType([FromQuery]string sjkdz)
    {
        //å°†æ•°æ®åº“åœ°å€è½¬æ¢ä¸ºfacctidï¼Œè¯¥æ–¹æ³•æ‰¾ä¸åˆ°facctidçš„è¯å°±ä¼šæŠ›å‡ºå¼‚å¸¸
        var FaccID =(await purchaseInfoService.GetFacctId(sjkdz)).ToString();

        string sql = "";
        //å¦‚æœæ˜¯æ˜†å±±è¾¾äºšè´¦å¥—
        if (FaccID == "1008")
        {
            sql = "SELECT FNumber,FName FROM t_Item WHERE FItemClassID  = 3002 AND FDeleted =0 ";
        }
        else if (FaccID == "1003")
        {
            sql = "SELECT FNumber,FName FROM t_Item WHERE FItemClassID  = 3010 AND FDeleted =0 ";
        }
        else
        {
            sql = " SELECT FNumber,FName FROM ICBillType WHERE FID NOT BETWEEN 3 AND 9";
        }

        //è·å–æ•°æ®è¡¨æ ¼
        var dt = await db.AsTenant().GetConnection(FaccID).Ado.GetDataTableAsync(sql);

        //datasã€dataæ˜¯æ³›å¾®è¦æ±‚çš„xmlè·¯å¾„
        dt.DataSet.DataSetName = "datas";
        dt.TableName = "data";

        using StringWriter stringWriter = new StringWriter();
        dt.WriteXml(stringWriter);
        return stringWriter.ToString();
    }
}
```

***

>è¿™ä¸ªsjkdzè¿™ä¸ªgetè¯·æ±‚çš„å‚æ•°å¦‚ä¸‹å›¾æ‰€ç¤º.
![](https://pictures.darkmoon.top/imgs/202306281021425.png)
![](https://pictures.darkmoon.top/imgs/202306281025617.png)
åœ¨æ­¤æµè§ˆæ¡†ä¸­åœ°å€å°±æ˜¯å€¼,ä¹Ÿå°±æ˜¯å°†åœ°å€æŒ‡å®šä¸ºäº†id,æ–¹ä¾¿åˆ‡æ¢è´¦å¥—æ—¶åšä¸åŒçš„æ“ä½œ.
![](https://pictures.darkmoon.top/imgs/202306281052841.png)
![](https://pictures.darkmoon.top/imgs/202306281054105.png)
æµ‹è¯•ä¸‹æ•ˆæœ,æˆ‘ä»¬ä»¥æ˜†å±±çš„ä¸ºä¾‹
![](https://pictures.darkmoon.top/imgs/202306281115572.jpg)

>å°†æ•°æ®åº“åœ°å€çš„å€¼å¤åˆ¶å‡ºæ¥,ä½œä¸ºå‚æ•°å‘ç»™è‡ªå®šä¹‰æ¥å£
![](https://pictures.darkmoon.top/imgs/202306281103279.png)
ç»“æœå¦‚ä¸‹
![](https://pictures.darkmoon.top/imgs/202306281107722.png)
![](https://pictures.darkmoon.top/imgs/202306281108805.png)
***
<font size=4>åˆ°æ­¤ä¸ºæ­¢è‡ªå®šä¹‰æ¥å£çš„æ“ä½œå¤§æ¦‚ä»‹ç»å®Œäº†ï¼Œç±»ä¼¼æ“ä½œä»¿å†™å°±å¯ä»¥äº†</font>
<font size=4>è¡¥å……å®Œä½™ä¸‹å­—æ®µçš„æ“ä½œåœ¨æ­¤å°±ä¸ä¸€ä¸€å±•ç¤ºäº†</font>
***
### 2.åŸç”Ÿsql
ä¸‹é¢æ˜¯éƒ¨é—¨å­—æ®µï¼Œè¿™ä¸ªå­—æ®µåœ¨ä¸åŒè´¦å¥—ä¸‹çš„sqlæ˜¯ç›¸åŒçš„
![](https://pictures.darkmoon.top/imgs/202306281138856.png)
é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª
![](https://pictures.darkmoon.top/imgs/202306281139957.png)
åŒæ ·çš„é—®é¢˜ï¼Œå¦‚ä½•åœ¨ä¸åŒçš„è´¦å¥—ä¸‹å»ä¸åŒçš„æ•°æ®åº“æ‰§è¡Œç›¸åŒçš„Sqlï¼Œä»¥å…¶ä»–å‡ºåº“å•ä¸ºä¾‹
![](https://pictures.darkmoon.top/imgs/202307100912428.png)
è¿™ä¸ª<font color="red"><b>\$sjkdz\$</b></font>åœ¨å“ªï¼Ÿæˆ–è€…å¯¹åº”è¡¨å•çš„ä»€ä¹ˆï¼Ÿ
![](https://pictures.darkmoon.top/imgs/202307100926888.png)
è¯¥å­—æ®µå¯¹åº”çš„æ˜¯è‡ªå®šä¹‰æµè§ˆæ¡†ï¼Œä¹Ÿå°±æ˜¯é›†æˆä¸­å¿ƒçš„æ•°æ®å±•ç°é›†æˆä¸­çš„ï¼š
![](https://pictures.darkmoon.top/imgs/202307100929263.png)
ç‰¹åˆ«æ³¨æ„ï¼Œè¯¥å­—æ®µçš„å€¼æ˜¯å…¶idï¼Œä¹Ÿå°±æ˜¯ï¼š
![](https://pictures.darkmoon.top/imgs/202307100935297.png)
å¼„æˆè¿™ç§å½¢å¼çš„åŸå› æ˜¯ï¼š
![](https://pictures.darkmoon.top/imgs/202307100936805.png)
ä¹Ÿå°±æ˜¯è¯´ï¼Œä»¥è¿™ç§å½¢å¼æ„å»ºçš„è¡¨å•ï¼Œé€‰æ‹©å®Œè´¦å¥—åï¼Œå…¶ä»–çš„æµè§ˆæ¡†ä¼šæ ¹æ®è´¦å¥—å­—æ®µçš„å€¼å»ä¸åŒçš„æ•°æ®åº“æ‰§è¡Œç›¸åŒsqlè¿”å›ä¸åŒçš„ç»“æœï¼Œç»“åˆè‡ªå®šä¹‰æµè§ˆæ¡†ï¼ŒåŸºæœ¬å¯ä»¥æ»¡è¶³å•ä¸ªè¡¨å•çš„å¤ç”¨ã€‚

### å‰ç«¯è¡¨å•æ„å»º
```javascript
//ä»¥é‡‡è´­è®¢å•ä¸ºä¾‹ï¼Œè¡¨å•ä¸­ç”¨åˆ°çš„æ–¹æ³•åœ¨æ–‡æ¡£ä¸­å¯æŸ¥ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šæ³¨è§£

<script>
    //åŸºç¡€åœ°å€ï¼Œæ–¹ä¾¿æ­£å¼ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒæ¥å›åˆ‡æ¢
    var baseUrl = `http://172.16.10.60:12345`;

    //è·å–ç¼–å·çš„å­—æ®µid
    var bhid = WfForm.convertFieldNameToId("bh")
    
    //è·å–åˆ†éƒ¨çš„å­—æ®µid
    var fb = WfForm.convertFieldNameToId("fb");
    
    //è´¦å¥—id
    var ztid = WfForm.convertFieldNameToId("sjkdz");
    
    //æ”¶è´§åœ°ç‚¹
    var shdd = WfForm.convertFieldNameToId("shdd");
    
    //é€è´§å•ä½
    var shdw = WfForm.convertFieldNameToId("shdw");
    
    //é‡‡è´­ç±»å‹
    var cglx = WfForm.convertFieldNameToId("cglx");
    
    //æºå•ç±»å‹
    var ydlxid = WfForm.convertFieldNameToId("ydlx");
    
    //ç”±äºè´¦å¥—å¯¹åº”çš„å€¼æ˜¯æ•°æ®åº“åœ°å€ï¼Œæ‰€ä»¥è¦æŸ¥å¤„æ”¹åœ°å€å¯¹åº”çš„è´¦å¥—idï¼Œå­˜å…¥facctid
    var facctid;
    
    var fqrid = WfForm.convertFieldNameToId("fqr");
    
    var ywyid = WfForm.convertFieldNameToId("ywy");
        
    var zdid = WfForm.convertFieldNameToId("zd");
    
    //è·å–ç»†è¡¨1ä¸­çš„ç›¸å…³å­—æ®µ
    //ç‰©æ–™åç§°å­—æ®µid
    var wlmcid = WfForm.convertFieldNameToId("wlmc", "detail_1")
    //ç‰©æ–™ä»£ç å­—æ®µid
    var wldmid = WfForm.convertFieldNameToId("wldm", "detail_1")
    //è§„æ ¼å‹å·å­—æ®µid
    var ggxhid = WfForm.convertFieldNameToId("ggxh", "detail_1")
    //å•ä½å­—æ®µid
    var dwid = WfForm.convertFieldNameToId("dw", "detail_1")
    //åº“å­˜æ•°é‡
    var kcsl = WfForm.convertFieldNameToId("kcsl", "detail_1")
    //å®‰å…¨åº“å­˜æ•°é‡
    var aqkcid = WfForm.convertFieldNameToId("aqkc", "detail_1")
    //é»˜è®¤ä»“åº“
    var mrckid = WfForm.convertFieldNameToId("mrck", "detail_1")
    //æºå•å•å·
    var yddh = WfForm.convertFieldNameToId("yddh", "detail_1")
    //ç‰©å“çš„ç¨ç‡
    var slid = WfForm.convertFieldNameToId("tax","detail_1")
    //ç‰©å“çš„æ•°é‡
    var wpslid = WfForm.convertFieldNameToId("sl","detail_1")

    //è·å–å‘èµ·äººåç§°
    var fqrmc = WfForm.getBrowserShowName(fqrid);

    //////////////////////////////////////////////////////////
    //å°†æ–¹æ³•æ”¾åœ¨WfFormå¯¹è±¡ä¸Šï¼Œç®€æ´ä»£ç 
    WfForm.pd = function(WfForm){
    //åˆ¤æ–­å‘èµ·äººæ˜¯å¦èƒ½åˆ›å»ºé‡‡è´­è®¢å•
     $.ajax({
         type:'GET',
         url:baseUrl+'/api/oAPurchaseOrderInfo/people',
         data:{fqr:fqrmc,FAcctID:facctid},
         dataType:"json",
         success:function(response){
           if(response.code != 200)
           {
             Dialog.alert("æ‚¨æ— æƒä½¿ç”¨æ­¤è¡¨å•ï¼Œå°†æ¸…ç©ºåˆ¶å•äººå’Œä¸šåŠ¡å‘˜å­—æ®µï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©");
             
             WfForm.changeFieldValue(ywyid, {
    value: "",
    specialobj:[]
    });

WfForm.changeFieldAttr(ywyid, 3)

//è¿™ä¸ªç‰¹åˆ«æ³¨æ„ï¼Œè¿™æ˜¯æ¸…ç©ºè‡ªå®šä¹‰æµè§ˆæ¡†çš„æ–¹æ³•ï¼Œç°åœ¨æ¸…ç©ºçš„æ˜¯è´¦å¥—å­—æ®µ
WfForm.changeFieldValue(zdid, {
    value: "",
        specialobj:[
    ]
});

WfForm.changeFieldAttr(zdid, 3)
           }else{
                
                //ä¸‹é¢è¿™ä¸ªè¯­å¥æ˜¯ç»™è‡ªå®šä¹‰æµè§ˆæ¡†èµ‹å€¼çš„æ–¹æ³•
                 WfForm.changeFieldValue(ywyid, {
                 value: response.result.ywy[0].fItemID,
                 specialobj:[
                     {id:response.result.ywy[0].fItemID,name:response.result.ywy[0].fName}
                 ]
               }); 

               WfForm.changeFieldAttr(ywyid, 1)
               
               WfForm.changeFieldValue(zdid, {
                 value: response.result.zdr[0].fUserID,
                 specialobj:[
                     {id:response.result.zdr[0].fUserID,name:response.result.zdr[0].fName}
                 ]
               }); 
               WfForm.changeFieldAttr(zdid, 1)
           }
           }
         })
    }
    ////////////////////////////////////////////////////////////
    //è·å–æ•°é‡é€šè¿‡æºå•çš„id
    WfForm.getNumByYdId = function(WfForm,id,rowIndex){
     $.ajax({
         type:'GET',
         url:baseUrl+'/api/oAPurchaseOrderInfo/slByLxAndEntryId',
         data:{lx:WfForm.getFieldValue(ydlxid),FAcctID:facctid,id:id},
         dataType:"json",
         success:function(response){
           WfForm.changeFieldValue(wpslid+"_"+rowIndex, {value:response.result});
           }
         })
    }
    ////////////////////////////////////////////////////////////
    //è·å–å•å·
    WfForm.getDh = function(WfForm){
       //æ”¹å˜è´¦å¥—å°±ä¿®æ”¹å•å·
       $.ajax({
            type:'GET',
            url: baseUrl+'/api/oAPurchaseOrderInfo/fBillNo',
            data:{FAcctID:facctid},
            success:function(response){
              if(response.result)
              {
                WfForm.changeFieldValue(bhid,{value:response.result});
              }else{
                Dialog.alert("åˆ‡æ¢è´¦å¥—è·å–é‡‡è´­å•å·å¤±è´¥")
              }
            }
       });
    }
    ////////////////////////////////////////////////////////////
  
    //å¼ºåˆ¶é™åˆ¶æºå•ç±»å‹ä¸ºé‡‡è´­ç”³è¯·å•
   WfForm.changeFieldValue(ydlxid, {
    value: "70",
    specialobj:[{id:"70",name:"é‡‡è´­ç”³è¯·å•"}]
   });
   WfForm.changeFieldAttr(ydlxid,1)
    
    //é€šè¿‡åˆ†éƒ¨åˆå§‹åŒ–è´¦å¥—ï¼Œæ¯”å¦‚æŸäººç»„ç»‡æ¶æ„ä¸­æœ€è¿‘çš„åˆ†éƒ¨çš„idä¸º2(æ˜†å±±è¾¾äºš)ï¼Œè¯¥è¯·æ±‚ä»¥åŠåç»­æ“ä½œä¼šå°†åˆ†éƒ¨idè½¬åŒ–ä¸ºæ•°æ®åº“åœ°å€å’Œåç§°ï¼Œä¾‹ï¼š"[172.16.10.23].[AIS20140317112522]","æ˜†å±±è¾¾äºšæ±½è½¦é›¶éƒ¨ä»¶æœ‰é™å…¬å¸"
        $.ajax({
        type:'GET',
        url:'http://172.16.10.60:12345/api/oAPurchaseInfo/dzInfo',
        data:{fb:WfForm.getFieldValue(fb)},
        dataType:"json",
        success:function(response){
            if(response.result.dz)
            {
                WfForm.changeFieldValue(ztid, {
                value: response.result.dz,
                specialobj:[
                    {id:response.result.dz,name:response.result.name}
                ]
              }); 
              
              WfForm.changeFieldAttr(ztid,2);
              
               //è¿™å¥è¯å°±æ˜¯æŸ¥æ‰¾æ•°æ®åº“åœ°å€
              $.ajax({
                  type:'GET',
                  url:'http://172.16.10.60:12345/api/oAPurchaseInfo/facctId',
                  data:{fserver:WfForm.getFieldValue(ztid)},
                  dataType:"json",
                  success:function(response){
                      if(facctid = response.result)
                      {
                          facctid = response.result;
                          
                              //åˆ¤æ–­å‘èµ·äººæ˜¯å¦èƒ½åˆ›å»ºé‡‡è´­è®¢å•
                              WfForm.pd(WfForm);
                              
                              WfForm.getDh(WfForm)

                          
                             WfForm.changeFieldAttr("field110", 1);
                      }else
                      {
                        Dialog.alert("è·å–äººå‘˜åˆ†éƒ¨ä¿¡æ¯å¤±è´¥")
                        return
                      }
                  }
              });
           }else{
             Dialog.alert("è·å–æ•°æ®åº“åœ°å€å¤±è´¥")
           }
           
        }
    });
    
    
        //è´¦å¥—å­—æ®µæ·»åŠ ç›‘å¬äº‹ä»¶
    WfForm.bindFieldChangeEvent(ztid,function(id,rowIndex,value){
        $.ajax({
            type:'GET',
            url:'http://172.16.10.60:12345/api/oAPurchaseInfo/facctId',
            data:{fserver:WfForm.getFieldValue(ztid)},
            dataType:"json",
            success:function(response){
                    if(response.result)
                    {
                    facctid = response.result;
                    }else{
                      Dialog.alert("åˆ‡æ¢è´¦å¥—è·å–idå¤±è´¥")
                      return
                    }
                    
                  WfForm.getDh(WfForm)
                    
                  // æ”¹å˜è´¦å¥—æ¸…é™¤é¡µé¢ä¸Šçš„å…¶å®ƒä¿¡æ¯
                  
                  //æ¯æ¬¡åˆ‡æ¢è´¦å¥—ï¼Œæ¸…ç©ºæ˜ç»†è¡¨
                  WfForm.delDetailRow("detail_1", "all");
                  
 
                  WfForm.pd(WfForm)
                  
                  //æ¸…ç©ºå­—æ®µä¿¡æ¯
                  if(facctid == 1008 || facctid == 1003)
                  {
                    WfForm.changeFieldValue(shdd, {
    value: "",
        specialobj:[
    ]
});
                    WfForm.changeFieldAttr(shdd,3)
                    
                    WfForm.changeFieldValue(shdw, {
    value: "",
        specialobj:[
    ]
});
                    WfForm.changeFieldAttr(shdw,3)
                    
                    WfForm.changeFieldValue(cglx, {
    value: "",
        specialobj:[
    ]
});
                    WfForm.changeFieldAttr(cglx,3)
                    
                  }else{
                    
                     WfForm.changeFieldValue(shdd, {
     value: "",
         specialobj:[
     ]
 });
                     WfForm.changeFieldAttr(shdd,2)
                  
                     WfForm.changeFieldValue(shdw, {
     value: "",
         specialobj:[
     ]
 });
                     WfForm.changeFieldAttr(shdw,2)
                  
                     WfForm.changeFieldValue(cglx, {
     value: "",
         specialobj:[
     ]
 });
                     WfForm.changeFieldAttr(cglx,2)
                   }
                  
           }
        });
    });
    
        
        
    
       //ä¾¦å¬æ˜ç»†è¡¨ç‰©æ–™ä»£ç å­—æ®µçš„å˜åŒ–ï¼Œè”åŠ¨å‡ºåç§°ã€è§„æ ¼å‹å·ã€å•ä½ç­‰å…¶ä»–å±æ€§
       WfForm.bindDetailFieldChangeEvent(wldmid,function(id,rowIndex,value){
         
         var fieldvalue = facctid;
         
         if(!fieldvalue)
         {
           if(WfForm.getDetailRowCount("detail_1") != 0){
             Dialog.alert("è´¦å¥—ä¸èƒ½ä¸ºç©ºï¼")
           }
           WfForm.delDetailRow("detail_1", "all");
           return
         }
         
           $.ajax({
              type:'GET',
              dataType:"json",
              url:'http://172.16.10.60:12345/api/oAPurchaseInfo/wl',
              data:{FItemID:value,type:1,FAcctID:fieldvalue},
              success:function(response){
                if(JSON.parse(response.result)[0])
                {
                  WfForm.changeFieldValue(wlmcid+"_"+rowIndex, {value:JSON.parse(response.result)[0].fName});
                  WfForm.changeFieldValue(ggxhid+"_"+rowIndex, {value:JSON.parse(response.result)[0].fModel});
                  WfForm.changeFieldValue(dwid+"_"+rowIndex, {value:JSON.parse(response.result)[0].unit});

                     
             //å¸¦å‡ºç‰©æ–™çš„åº“å­˜
             $.ajax({
              type:'GET',
              dataType:"json",
              url:baseUrl+'/api/oAPurchaseInfo/qty',
              data:{facctid:fieldvalue,fitemId:value},
              success:function(response){
                
                if(response.code != 200)
                {
                  WfForm.changeFieldValue(kcsl+"_"+rowIndex, {value:0});
                }
                
                //ç»™åº“å­˜æ•°é‡èµ‹å€¼
                WfForm.changeFieldValue(kcsl+"_"+rowIndex, {value:(response.result+0)});
              }
             })
                //if(!response.result)
                //Dialog.alert(response.message)
                
                //å¸¦å‡ºç‰©æ–™çš„é»˜è®¤ä»“åº“å’Œå®‰å…¨åº“å­˜
              $.ajax({
              type:'GET',
              dataType:"json",
              url: baseUrl+`/api/oAPurchaseOrderInfo/warehouseInfo`,
              data:{fItemID:value,fAcctID:fieldvalue},
              success:function(response){
                WfForm.changeFieldValue(aqkcid+"_"+rowIndex, {value:JSON.parse(response.result)[0].fSecInv});
                WfForm.changeFieldValue(mrckid+"_"+rowIndex, {value:JSON.parse(response.result)[0].fName});
              }})
              
              //å¸¦å‡ºç‰©å“çš„ç¨ç‡
              $.ajax({
              type:'GET',
              dataType:"json",
              url: baseUrl+`/api/oAPurchaseOrderInfo/tax`,
              data:{fItemID:value,fAcctID:fieldvalue},
              success:function(response){
                WfForm.changeFieldValue(slid+"_"+rowIndex, {value:Number(response.result)});
              }});
              
            }else{
              Dialog.log("å¸¦å‡ºç‰©æ–™ä¿¡æ¯å¤±è´¥!")
            }
              }
           })
       })
            
              //ä¾¦å¬æ˜ç»†è¡¨æºå•å•æ®å­—æ®µçš„å˜åŒ–
              WfForm.bindDetailFieldChangeEvent(yddh,function(id,rowIndex,value){
         
                var fieldvalue = facctid;
                
                if(!fieldvalue)
                {
                  if(WfForm.getDetailRowCount("detail_1") != 0){
                    Dialog.alert("è´¦å¥—ä¸èƒ½ä¸ºç©ºï¼")
                  }
                  WfForm.delDetailRow("detail_1", "all");
                  return
                }
                
                  $.ajax({
                     type:'GET',
                     dataType:"json",
                     url: baseUrl+`/api/oAPurchaseOrderInfo/itemInfoByPoRequestEntryId`,
                     data:{fDetailID:value,FAcctID:fieldvalue},
                     success:function(response){
                       if(JSON.parse(response.result)[0])
                       {
                         WfForm.changeFieldValue(wldmid+"_"+rowIndex,{
                           value:JSON.parse(response.result)[0].fItemID,
                           specialobj:[
                               {id:JSON.parse(response.result)[0].fItemID,name:JSON.parse(response.result)[0].fNumber}
                           ]
                         }); 
                       }
                     }
                  }
                  )
                  
                  //æ›´æ”¹ç‰©å“çš„æ•°é‡
                  WfForm.getNumByYdId(WfForm,value,rowIndex);
              }
              )
</script>
```

### åç«¯ä»£ç 

[furionæ¡†æ¶åœ°å€](http://furion.baiqian.ltd/docs/category/appendix)
[sqlsugaræ¡†æ¶åœ°å€](https://www.donet5.com/Home/Doc)
[Admin.NETæƒé™æ ¡éªŒæ¡†æ¶åœ°å€](https://gitee.com/zuohuaijun/Admin.NET?_from=gitee_search)

Admin.NETæ¡†æ¶æ˜¯åŸºäºfurionå’ŒsqlsugaräºŒæ¬¡å¼€å‘çš„æƒé™æ ¡éªŒæ¡†æ¶ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ï¼Œä¸€èˆ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æµæ§ã€osså¯¹è±¡å­˜å‚¨ã€OAuthç­‰åŠŸèƒ½éƒ½æ˜¯æœ‰çš„ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œå¯å®šåˆ¶åŒ–ç¨‹åº¦é«˜ã€‚å¼€ç®±å³ç”¨ï¼Œé…åˆ[vform](https://vform666.com)(vueé¡µé¢æ„å»ºæ‹–æ‹‰æ‹½å·¥å…·)ï¼Œèƒ½å¿«é€Ÿçš„æ„å»ºé¡µé¢ã€‚ä¸€èˆ¬çš„å°æ¥å£å¯ä»¥è€ƒè™‘ç”¨furion pureï¼Œå°å·§æ–¹ä¾¿ã€‚furionæœ€çˆ½çš„åœ°æ–¹åœ¨äºå¯¹æ¥å£è¿”å›æ•°æ®ç±»å‹è¦æ±‚è¾ƒä¸ºå®½æ³›ï¼Œèƒ½è‡ªåŠ¨è½¬æ¢ç›¸å½“å¤šçš„æ•°æ®ç±»å‹ã€‚æ¯”å¦‚æˆ‘è¿”å›ä¸€ä¸ªå­—å…¸ç±»å‹å¯¹è±¡ï¼Œé”®æ˜¯Stringå€¼æ˜¯æŸä¸ªç±»å¯¹è±¡ï¼Œå¦‚æœåªé .net coreï¼Œè¿˜å¯èƒ½å¾—æœ‰å®ä½“ç±»ï¼Œè¦ä¸¥æ ¼ä¹¦å†™è¿”å›ç±»å‹ï¼Œä½†ç°åœ¨æ¥å£è¿”å›ç±»å‹ç›´æ¥å†™objectå°±è¡Œäº†ï¼Œå­—å…¸å€¼å¯ä»¥æ˜¯åŒ¿åç±»å¯¹è±¡ã€‚

å…·ä½“çš„furionæ“ä½œæ–¹æ³•æ¡†æ¶çš„å®˜ç½‘éƒ½æœ‰ä»‹ç»ï¼Œåœ¨æ­¤ä¸åšèµ˜è¿°ã€‚

#### æµç¨‹å›å†™çš„ä»£ç 
>ä»¥å…¶ä»–å‡ºåº“å•ä¸ºä¾‹ï¼Œå› ä¸ºè¿™ä¸ªå•æ®æ¶‰åŠåˆ°å¤šçº§å®¡æ ¸ã€‚

```csharp
using Admin.NET.Application.Enum;
using Admin.NET.Application.Service.OAPurchase;
using Admin.NET.Application.Util;
using Furion.FriendlyException;
using Furion.RemoteRequest.Extensions;
using Microsoft.AspNetCore.Authorization;
using SqlSugar;
using System.Data;
using System.Linq;
using System.Net.Http;
using System.Threading;

namespace Admin.NET.Application.Service.OAOtherDelivery;
//è¯¥æ³¨è§£è¡¨ç¤ºä»»ä½•äººéƒ½å¯ä»¥è®¿é—®è¯¥ç±»ä¸‹çš„æ¥å£
[AllowAnonymous]
//swaggerçš„æ¥å£åˆ†ç±»
[ApiDescriptionSettings("å…¶ä»–å‡ºåº“å•")]
//IDynamicApiControllerï¼šæ˜¯furionçš„æ§åˆ¶å™¨æ¥å£ï¼Œè¡¨ç¤ºè¯¥ç±»æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼ŒITransientå¯åŠ å¯ä¸åŠ ï¼Œè¡¨ç¤ºè¯¥ä¹Ÿæ˜¯æœåŠ¡ç±»ï¼Œå¯è¢«å…¶ä»–ITransientç±»æ³¨å…¥è°ƒç”¨ã€‚
public class OAOtherDeliveryFlowPathService:IDynamicApiController,ITransient
{
    private string facctid;

    //ç”¨äºè·å–tokençš„å·¥å…·ç±»(å•ä¾‹)
    private readonly OATokenUtil tokenUtil;

    //ç”¨äºè·å–æ˜ç»†è¡¨æ•°æ®çš„å·¥å…·ç±»(å•ä¾‹)
    private readonly GetWorkflowResponseInfoUtil getWorkflowResponseInfoUtil;

    //sqlsugar
    ISqlSugarClient db;

    IAdo ado = null;

    //å¤šçº§å®¡æ ¸
    private readonly MultilevelAuditingUtil multilevelAuditingUtil;
    //é‡‡è´­è®¢å•ä¿¡æ¯æœåŠ¡
    private readonly OAPurchaseInfoService oAPurchaseInfoService;

    //æ„é€ å‡½æ•°ï¼Œç”¨äºæ³¨å…¥æœåŠ¡
    public OAOtherDeliveryFlowPathService(OATokenUtil tokenUtil, GetWorkflowResponseInfoUtil getWorkflowResponseInfoUtil, ISqlSugarClient db, OAPurchaseInfoService oAPurchaseInfoService, MultilevelAuditingUtil multilevelAuditingUtil)
    {
        this.tokenUtil = tokenUtil;
        this.getWorkflowResponseInfoUtil = getWorkflowResponseInfoUtil;
        this.db = db;
        this.oAPurchaseInfoService = oAPurchaseInfoService;
        this.multilevelAuditingUtil = multilevelAuditingUtil;
    }

    /// <summary>
    /// å›å†™k3å…¶ä»–å‡ºåº“å•
    /// </summary>
    /// <param name="requestId">oaæµç¨‹id</param>
    /// <param name="userId">oaå•æ®å‘èµ·äººid</param>
    /// <returns></returns>
    public async Task<string> GetWriteBackToOAOtherDelivery([FromQuery] string requestId, [FromQuery] string userId)
    {
        //è·å–tokenå­—å…¸ï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªspkå’Œtoken
        var keyValues = (await tokenUtil.GetToken()).ToDictionary();
    
        String response = "";
    
        string trueFBillNo = null;
    
        //å¦‚æœè¯¥å­—å…¸çš„é•¿åº¦ä¸º2
        if (keyValues.Count == 2)
        {
            //è·å–æµç¨‹ä¿¡æ¯(é‡‡è´­ç”³è¯·å•)ï¼Œäº”ç§’è¿‡æœŸæ—¶é—´
            response = await "http://172.16.10.29:8008/api/workflow/paService/getWorkflowRequest"
                            .SetHeaders(new { token = keyValues["token"].ToString(), appid = OATokenUtil.appid, userid = tokenUtil.RSAEncrypt(tokenUtil.RSAPublicKey(keyValues["spk"].ToString()), userId) })
                            .SetQueries(new { requestId = requestId })
                            .SetHttpMethod(HttpMethod.Get)
                            .SendAsStringAsync(new CancellationTokenSource(millisecondsDelay: 5000).Token);
        }
        else
        {
            throw Oops.Oh(PurchaseFlowPathErrorCodeEnum.F0001);
        }
        //é€šè¿‡å·¥å…·è·å–ä¸»è¡¨ä¿¡æ¯
        var mainRecords = getWorkflowResponseInfoUtil.GetMainTableRecords(response);
    
        //ç”¨è¿‡å·¥å…·è·å–ç»†è¡¨ä¿¡æ¯(æ˜ç»†è¡¨1)
        var detailRecords = getWorkflowResponseInfoUtil.GetDetailTableRecords(response, 0);

        //===========================================================================================================================================================

        //ğŸ‘†ä»¥ä¸Šçš„é™¤äº†æ³¨å…¥çš„æœåŠ¡å¯èƒ½æœ‰ç‚¹ä¸åŒï¼Œå…¶ä»–çš„å¤§å¤šéƒ½æ˜¯ç›¸åŒçš„ã€‚

        //è·å–è´¦å¥—çš„æ•°æ®åº“é“¾æ¥åœ°å€
        var dz = (from d in mainRecords.AsEnumerable() where d.fieldName == "sjkdz" select d.fieldValue)?.ToList()?[0];
    
        if (!String.IsNullOrEmpty(dz))
        {
            //é€šè¿‡åœ°å€è·å–è´¦å¥—çš„id
            facctid = (await oAPurchaseInfoService.GetFacctId(dz)).ToString(); ;
    
            ado = db.AsTenant().GetConnection(facctid).Ado;

            await ado.BeginTranAsync();
        }
        else
        {
            //è¿™ä¸ªæ˜¯furionä¸­çš„è¿”å›å¼‚å¸¸çš„æ–¹æ³•ï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªjson
            //è¯¥jsonä¸»è¦çœ‹ï¼šcodeå’Œresult
            //æŠ›å‡ºå¼‚å¸¸codeé200ï¼Œå‰ç«¯æˆ‘ä¹ˆå°±å¯ä»¥å†™if(response.code != 200) {Dialog.alert(response.result)}
            throw Oops.Oh("è·å–æ•°æ®åº“åœ°å€å¤±è´¥");
        }

        /*æ˜è¡¨æ•°æ®ï¼Œæ²¡ä»€ä¹ˆå¥½æ³¨æ„çš„ï¼Œä¸»è¦å°±æ˜¯fieldValueå’ŒfieldShowValueï¼ŒfieldValueæ˜¯æ³›å¾®å‰ç«¯è¡¨å•å­—æ®µå¯¹åº”çš„
        å€¼ï¼Œæ¯”å¦‚å‘èµ·äººæ˜¾ç¤ºçš„æ˜¯æˆ‘çš„åå­—ï¼Œä½†æ˜¯fieldValueæ˜¯æˆ‘åœ¨æ³›å¾®ä¸­çš„idï¼š14,è€ŒfieldShowValueæ˜¯æˆ‘çš„äººåï¼šèŒƒxx
        ï¼Œåæ­£ä»¥è¿™ç§æ–¹å¼*/
        //å‡ºåº“å•ç±»å‹
        var ckdlx = (from d in mainRecords.AsEnumerable() where d.fieldName == "ckdlx" select d.fieldValue)?.ToList()[0] ?? "NULL";
        //å•æ®æ—¥æœŸ
        var djrq = (from d in mainRecords.AsEnumerable() where d.fieldName == "djrq" select d.fieldValue)?.ToList()[0] ?? "NULL";
        //éƒ¨é—¨
        var bm = (from d in mainRecords.AsEnumerable() where d.fieldName == "bm" select d.fieldValue)?.ToList()[0] ?? "NULL";
        //æ”¶è´§ä»“åº“
        var shck = (from d in mainRecords.AsEnumerable() where d.fieldName == "shck" select d.fieldValue)?.ToList()[0] ?? "NULL";
        //åˆ¶å•äºº
        var zdr = (from d in mainRecords.AsEnumerable() where d.fieldName == "fqr" select d.fieldShowValue)?.ToList()[0] ?? "NULL";
        //é¢†æ–™
        var ll = (from d in mainRecords.AsEnumerable() where d.fieldName == "ll" select d.fieldValue)?.ToList()[0] ?? "NULL";
        //å‘è´§
        var fh = (from d in mainRecords.AsEnumerable() where d.fieldName == "fh" select d.fieldValue)?.ToList()[0] ?? "NULL";

        var m_Data1 = m_Data;

        //ç»†è¡¨æ•°æ®
        if (detailRecords.Count() > 0)
        {
            foreach (var record in detailRecords)
            {
                //ç‰©æ–™id
                string wlid = (from d in record.workflowRequestTableFields.AsEnumerable() where d.fieldName == "wldm" select d.fieldValue)?.ToList()[0];
                wlid = db.AsTenant().GetConnection(facctid).Ado.GetString($"select ICInventory.FItemID from ICInventory where FBrNo+'_'+convert(nvarchar, FItemID)+'_'+ FBatchNo+'_'+convert(nvarchar, FStockID)+'_'+convert(nvarchar, FStockPlaceID)+'_'+convert(nvarchar, FKFPeriod)+'_'+ FKFDate+'_'+convert(nvarchar, FAuxPropID)+'_'+ FMTONo+'_'+convert(nvarchar, FSupplyID) = '{wlid}'");
                //æ•°é‡
                string sl = (from d in record.workflowRequestTableFields.AsEnumerable() where d.fieldName == "sl" select d.fieldValue)?.ToList()[0];
                //æ‰¹æ¬¡å·
                string pc = (from d in record.workflowRequestTableFields.AsEnumerable() where d.fieldName == "pc" select d.fieldValue)?.ToList()[0];

                int max = 0;
                if (m_Data1.Rows.Count != 0)
                {
                    max = (int)m_Data1.Compute("Max(ID)", null);
                }
                var drTmp = m_Data1.NewRow();
                drTmp["ID"] = max + 1;

                string sqlItem = @"  SELECT b.FNumber ItemNumber,b.FName ItemName,b.FModel ItemMode,b.FUnitID,d.FName unit,
                    c.FName FStockName,a.*
				    FROM ICInventory a
				    LEFT JOIN t_ICItem b  ON b.FItemID = a.FItemID
				    LEFT JOIN t_Stock c  ON c.FItemID =a.FStockID 
				    LEFT JOIN t_Item d ON d.FItemID =b.FUnitID
				    WHERE a.FItemID ='" + wlid + "' and a.FBatchNo ='" + pc + "'  AND a.FQty >0 ";

                DataTable dt_item = await db.AsTenant().GetConnection(facctid).Ado.GetDataTableAsync(sqlItem);

                if (dt_item.Rows.Count > 0)
                {
                    drTmp["ItemID"] = dt_item.Rows[0]["FItemID"].ToString();
                    drTmp["ItemNumber"] = dt_item.Rows[0]["ItemNumber"].ToString();
                    drTmp["ItemMode"] = dt_item.Rows[0]["ItemMode"].ToString();
                    drTmp["FBatchNo"] = dt_item.Rows[0]["FBatchNo"].ToString();
                    drTmp["UnitID"] = dt_item.Rows[0]["FUnitID"].ToString();
                    drTmp["Unit"] = dt_item.Rows[0]["unit"].ToString();
                    drTmp["FStockID"] = dt_item.Rows[0]["FStockID"].ToString();
                    drTmp["FStockName"] = dt_item.Rows[0]["FStockName"].ToString();

                    drTmp["FQty"] = decimal.Parse(sl);
                    m_Data1.Rows.Add(drTmp);
                }
            }
            m_Data1.AcceptChanges();
        }

        //è¿™ä¸ªæ˜¯æ£€æŸ¥k3ä¸­æ˜¯å¦æœ‰è¯¥ç”¨æˆ·æ²¡æœ‰å°±æ’å…¥ï¼Œæ³¨æ„æ£€æŸ¥çš„æ˜¯äººåï¼Œk3ä¸­ä¸€å®šè¦æœ‰ä¸€ä¸ªè´¦å·åå­—å«ï¼š"OAå¤åˆ¶ç”¨è´¦å·"
        //é¦–å…ˆæ£€æŸ¥åˆ¶å•äººæ˜¯å¦å­˜åœ¨
        var checkCountZdr = db.AsTenant().GetConnection(facctid).Ado.GetInt($"select count(FUserID) from t_User where FName = '{zdr}'");
        if (checkCountZdr == 0)
        {
            //å¤åˆ¶å‡ºä¸€ä¸ªåŒåçš„ç”¨æˆ·åˆ°ç”¨æˆ·è¡¨
            db.AsTenant().GetConnection(facctid).Ado.UseStoredProcedure().ExecuteCommand("InsertErpUser", new SugarParameter("@erpName", "OAå¤åˆ¶ç”¨è´¦å·"), new SugarParameter("@userName", zdr));
        }

        //æ„å»ºå­˜å‚¨è¿‡ç¨‹å‚æ•°
        var fBillType = new SugarParameter("@fBillType", ckdlx);
        var fDate = new SugarParameter("@fDate", djrq);
        var fDepart = new SugarParameter("@fDepart", bm);
        //var fDCStock = new SugarParameter("@fDCStock", shck);
        var fBiller = new SugarParameter("@fBiller", zdr);
        var fFManager = new SugarParameter("@fFManager", ll);
        var fSManager = new SugarParameter("@fSManager", fh);
        var datatable = new SugarParameter("@datatable", m_Data1);
        datatable.TypeName = "otherOtherDelivery";

        try
        {
            //æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œæœ€å¥½ä¸è¦å¼‚æ­¥ä¼šå‡ºé—®é¢˜ã€‚
            var billNo = db.AsTenant().GetConnection(facctid).Ado.UseStoredProcedure().GetString("OtherDeliveryK3", fBillType, fDate, fDepart,fBiller, fFManager, fSManager, datatable);

            if (billNo.Contains("ERROR"))
            {
                throw Oops.Oh(billNo);
            }

            else
            {
                //é‡ç‚¹æ¥äº†ï¼Œèµ°åˆ°å½’æ¡£èŠ‚ç‚¹å‰åæ˜¯æ— æ³•çœ‹è§å‰ä¸€ä¸ªæµç¨‹çš„ä¿¡æ¯çš„ï¼Œæˆ‘è¿™è¾¹æ˜¯å¼€ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…15ç§’åè¿›è¡Œå¤šçº§å®¡æ ¸æ’å…¥æ“ä½œ
                //å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œ15ç§’åæ‰§è¡Œï¼Œå¦‚æœä¸è¿™æ ·åšä¼šæ‰¾ä¸åˆ°å½’æ¡£èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
                Thread t = new Thread(async () =>
                {
                    Thread.Sleep(15000);

                    //è·å–æµç¨‹ä¿¡æ¯(é‡‡è´­ç”³è¯·å•)ï¼Œäº”ç§’è¿‡æœŸæ—¶é—´
                    var response_1 = await "http://172.16.10.29:8008/api/workflow/paService/getWorkflowRequest"
                                    .SetHeaders(new { token = keyValues["token"].ToString(), appid = OATokenUtil.appid, userid = tokenUtil.RSAEncrypt(tokenUtil.RSAPublicKey(keyValues["spk"].ToString()), userId) })
                                    .SetQueries(new { requestId = requestId })
                                    .SetHttpMethod(HttpMethod.Get)
                                    .SendAsStringAsync(new CancellationTokenSource(millisecondsDelay: 5000).Token);
                    //å®¡æ ¸ç”¨æˆ·id
                    var auditorIds = new List<int>();
                    //è·å¾—æµç¨‹å†å²è®°å½•
                    var operateInfos = getWorkflowResponseInfoUtil.GetWorkflowRequestLogs(response_1);
                    //æŸ¥æ‰¾æœ€åä¸€ä¸ªå®¡æ‰¹èŠ‚ç‚¹æ“ä½œä¸ºå›é€€çš„èŠ‚ç‚¹
                    var MaxRollBackId = (from d in operateInfos.AsEnumerable() where d.nodeName.Trim() == "å®¡æ‰¹" && d.operateType.Trim() == "é€€å›" select d.id).Max();
                    //å¦‚æœæ²¡æœ‰å°±è®¾ç½®ä¸º0
                    MaxRollBackId = string.IsNullOrEmpty(MaxRollBackId) ? "0" : MaxRollBackId;
                    //å°†æœ€åä¸€ä¸ªå›é€€èŠ‚ç‚¹(å¦‚æœå­˜åœ¨)ä¹‹åçš„æ‰¹å‡†èŠ‚ç‚¹ä¸”è¯¥èŠ‚ç‚¹æ“ä½œç±»å‹ä¸ºæäº¤çš„æ“ä½œäººå‘˜åç§°æˆªå–å‡ºæ¥
                    var auditors = (from d in operateInfos.AsEnumerable() where d.nodeName.Trim() == "å®¡æ‰¹" && Int32.Parse(d.id) > Int32.Parse(MaxRollBackId) select d.operatorName)?.ToList();

                    if (auditors.Count > 0)
                    {
                        //é¦–å…ˆæ£€æŸ¥æ¯ä¸ªå®¡æ ¸äººæ˜¯å¦éƒ½æ˜¯å­˜åœ¨çš„ï¼Œä¸å­˜åœ¨å°†å…¶æ’å…¥
                        auditors.ForEach(e =>
                        {
                            var checkCount = db.AsTenant().GetConnection(facctid).Ado.GetInt($"select count(FUserID) from t_User where FName = '{e}'");
                            if (checkCount == 0)
                            {
                                //å¤åˆ¶å‡ºä¸€ä¸ªåŒåçš„ç”¨æˆ·åˆ°ç”¨æˆ·è¡¨
                                db.AsTenant().GetConnection(facctid).Ado.UseStoredProcedure().ExecuteCommand("InsertErpUser", new SugarParameter("@erpName", "OAå¤åˆ¶ç”¨è´¦å·"), new SugarParameter("@userName", e));
                            }
                            //è·å–å¤åˆ¶åçš„åˆ¶å•äººIdå¹¶ä¿å­˜è‡³æ•°ç»„
                            auditorIds.Add(db.AsTenant().GetConnection(facctid).Ado.SqlQuery<int>($"SELECT FUserID FROM t_User where t_User.FName = '{e}'")[0]);
                        });

                        //æ ¹æ®å•æ®ç¼–å·è¿”å›å•æ®id
                        var interID = db.AsTenant().GetConnection(facctid).Ado.GetString($"select FInterID from ICStockBill where FBillNo = '{billNo}'");

                        //å®¡æ ¸
                        db.AsTenant().GetConnection(facctid).Ado.UseStoredProcedure().ExecuteCommand("OtherDeliveryK3_Check", new SugarParameter("@FInterID", interID), new SugarParameter("@userName", auditors[0]));

                        //å°†è¯¥æ•°ç»„åè½¬
                        auditorIds.Reverse();

                        //å¤šçº§å®¡æ ¸
                        for (int i = 1; i <= auditorIds.Count; i++)
                        {
                            if (i > 6)
                            {
                                break;
                            }
                            //ä»¥ä¸‹æ˜¯å¤šçº§å®¡æ ¸çš„æ–¹æ³•ï¼Œä»£ç å‚æ•°åˆ†åˆ«ä¸ºè´¦å¥—idï¼Œå®¡æ ¸çº§åˆ«ï¼Œå®¡æ ¸äººï¼Œæ—¶é—´ï¼Œå•æ®idï¼Œå•æ®ç±»åˆ«ï¼Œè¡¨å•è¡¨å
                            multilevelAuditingUtil.MultilevelAudit(facctid, i, auditorIds[i - 1], DateTime.Now, Int32.Parse(interID), 29, "ICStockBill");
                        }
                    }
                });
                t.Start();
                }

            if (billNo.Contains("ERROR"))
            {
                throw new Exception(billNo);
            }

            ado.CommitTran();

            //æ ¹æ®å•æ®æ“ä½œçš„å†å²å®¡æ‰¹èŠ‚ç‚¹è®°å½•åå†™k3å¤šçº§å®¡æ‰¹æ“ä½œ
            //var operateInfos = getWorkflowResponseInfoUtil.GetWorkflowRequestLogs(response);
            //var logs = (from d in operateInfos.AsEnumerable() where d.nodeName.Trim() == "å®¡æ‰¹" select d.operatorName)?.ToList()?[0];
            //å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œè¿”å›çš„æ˜¯å•æ®çš„å•å·ï¼Œå•å·è¦ç”¨æ¥å›å†™å½’æ¡£è¡¨å•çš„ç¼–å·å­—æ®µ
            return billNo;
        }
        catch (Exception ex)
        {
            //æäº¤äº‹åŠ¡
            ado.RollbackTran();
            throw Oops.Oh(ex.Message);
        }
    }
    //===========================================================================================================================================================

    private DataTable m_Data
    {
        get
        {
            DataTable dt = new DataTable();
            dt.Columns.Add("ID", typeof(int));
            dt.Columns.Add("ItemID");
            dt.Columns.Add("ItemNumber");
            dt.Columns.Add("ItemMode");
            dt.Columns.Add("FBatchNo");//æ‰¹æ¬¡
            dt.Columns.Add("UnitID");
            dt.Columns.Add("Unit");//å•ä½
            dt.Columns.Add("FQty");
            //dt.Columns.Add("FSecUnitID");
            //dt.Columns.Add("FSecUnitID_DSPName");//è¾…åŠ©å•ä½
            //dt.Columns.Add("FSecCoefficient");//æ¢ç®—ç‡
            //dt.Columns.Add("FSecQty");//è¾…åŠ©æ•°é‡
            //dt.Columns.Add("FPlanPrice");//è®¡åˆ’å•ä»·
            //dt.Columns.Add("FPrice");//å•ä»·
            //dt.Columns.Add("FAmount");//é‡‘é¢
            //dt.Columns.Add("FNote");//å¤‡æ³¨
            dt.Columns.Add("FStockID");//å‘è´§ä»“åº“
            dt.Columns.Add("FStockName");
            //dt.Columns.Add("FDCSPID");//ä»“ä½
            //dt.Columns.Add("FDCSPName");
            return dt;
        }
    }
}
```

### ESBæ¥å£çš„é…ç½®
>ä»¥å…¶ä»–å‡ºåº“å•ä¸ºä¾‹ã€‚
1. é¦–å…ˆè½¬åˆ°ESBä¸­å¿ƒçš„èµ„æºç®¡ç†
![(o|o) ](https://pictures.darkmoon.top/imgs/202307121242493.png)
2. ç„¶åæ¨¡å—ç®¡ç†ï¼Œåˆ›å»ºäº†ä¸€ä¸ªä»“åº“ç®¡ç†æ¨¡å—(è¿™ä¸ªæ­¥éª¤å¯ä»¥çœç•¥ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†)
![](https://pictures.darkmoon.top/imgs/202307121300297.png)
3. ç„¶åé…ç½®æ¥å£
>å¯ä»¥çœ‹å‡ºé…ç½®æ¨¡å—è¿˜æ˜¯æœ‰å¿…è¦çš„ï¼Œèƒ½è®©æ¥å£åˆ†ç±»æ›´åŠ æ¸…æ™°
![](https://pictures.darkmoon.top/imgs/202307121304622.png)

>ç„¶åæ˜¯é…ç½®æ¥å£
æ¥å£æˆ‘æ˜¯å°†æœ€åä¸€ä¸ªèµ„æºè·¯å¾„è®¾ä¸ºå˜é‡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å°†è¯·æ±‚è·¯å¾„åœ¨è¿™ä¸ªåœ°æ–¹å†™æ­»
![](https://pictures.darkmoon.top/imgs/202307121309053.png)
ä¸‹é¢æ˜¯è¯·æ±‚æ•°æ®
![](https://pictures.darkmoon.top/imgs/202307121313883.png)
ä¸‹é¢æ˜¯å“åº”çš„æ•°æ®
![](https://pictures.darkmoon.top/imgs/202307121323148.png)
ä¸‹é¢æ˜¯æˆåŠŸçš„æ ‡è¯†
![](https://pictures.darkmoon.top/imgs/202307121324878.png)
ä¸‹é¢æ˜¯å¤±è´¥çš„è¯´æ˜ï¼Œå°±æ˜¯å“åº”çš„ä¸­çš„result
![](https://pictures.darkmoon.top/imgs/202307121325359.png)

4. ç„¶åæ˜¯äº‹ä»¶ï¼Œè¿™ä¸ªäº‹ä»¶æ›´åƒæ˜¯å¼€å‘ä¸­çš„æ¥å£ï¼Œèµ·åˆ°çº¦æŸçš„ä½œç”¨ï¼Œä½†æ˜¯é…ç½®åº”ç”¨æ—¶è¦ç”¨
![](https://pictures.darkmoon.top/imgs/202307121335629.png)
![](https://pictures.darkmoon.top/imgs/202307121335614.png)
![](https://pictures.darkmoon.top/imgs/202307121336707.png)

5. æœ€åæ˜¯åº”ç”¨çš„é…ç½®ï¼Œå¯ä»¥å‚ç…§å†™å¥½çš„åº”ç”¨é…ç½®ï¼Œåœ¨æ­¤ä¸åšèµ˜è¿°ã€‚
![](https://pictures.darkmoon.top/imgs/202307121333680.png)

### æ—¥å¿—è®°å½•
>æ—¥å¿—é¡µé¢å°±æ˜¯æœ€åŸºç¡€çš„é¡µé¢ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ¡†æ¶è‡ªå¸¦çš„ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆ
>ç”µè„‘è¦å®‰è£…node.jsï¼Œä¸»è¦æ˜¯ç”¨å…¶å‰ç«¯åŒ…ç®¡ç†å·¥å…·npm
[node.jså®˜ç½‘](https://nodejs.org/zh-cn)
ä¸‹è½½å®‰è£…ç¬¬ä¸€ä¸ªå°±å¥½äº†
ps:å¦‚æœå“ªå¤©æœ‰å¤šä¸ªnode.jsç‰ˆæœ¬ä¹‹é—´æ¥å›æ›´æ”¹çš„éœ€æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥è¯•è¯• [nvm](https://github.com/coreybutler/nvm-windows/releases)ï¼Œå¯ä»¥éšæ„åˆ‡æ¢node.jsçš„ç‰ˆæœ¬
1. å®‰è£…admin.netéœ€è¦çš„ä¾èµ–ï¼Œå°†admin.netæ–‡ä»¶å¤¹ä¸‹çš„webæ–‡ä»¶å¤¹æ‹–å…¥vs codeï¼Œç„¶åctrl+j å”¤å‡ºç»ˆç«¯ï¼Œç„¶åæ‰§è¡Œä»£ç npm iï¼Œæˆ‘è¿™ä¸ªæ˜¯å·²ç»å®‰è£…å¥½äº†
![](https://pictures.darkmoon.top/imgs/202307121411189.png)
2. ç„¶åè¾“å…¥npm run devå¯åŠ¨é¡¹ç›®ï¼Œæ³¨æ„ï¼šåç«¯çš„amin.neté¡¹ç›®è¦å¯åŠ¨èµ·æ¥
![](https://pictures.darkmoon.top/imgs/202307121413036.png)
3. ä¹‹åè¿›å…¥é¡µé¢ï¼Œæ³¨æ„è¿™ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«æ˜¯å¼€å‘ç¯å¢ƒä¸‹å’Œç”Ÿäº§ç¯å¢ƒä¸‹çš„å‰ç«¯æ‰€æŒ‡å‘çš„åç«¯åœ°å€ï¼Œå¯ä»¥ä¾æ®å…·ä½“æƒ…å†µåšè°ƒæ•´
![](https://pictures.darkmoon.top/imgs/202307121420155.png)
4. ç„¶åæˆ‘ä»¬æ¥é…ç½®èœå•ï¼Œå°±å«K3ä»“åº“ç®¡ç†
![](https://pictures.darkmoon.top/imgs/202307121446808.png)
5.  