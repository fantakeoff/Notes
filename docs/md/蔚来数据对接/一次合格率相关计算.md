### 工位一次合格率
```sql
DECLARE @PRODUCTNO NVARCHAR(999) = '11.YC01.P0235220'
--当前步骤
DECLARE @OPNO NVARCHAR(999) = 'GP12'
--最终步骤，如果是成品最终步骤那么涉及到出入库
DECLARE @FINALPROCESS NVARCHAR(999) = 'GP12'

if(OBJECT_ID('tempdb..#SNTempTable')) is not null
drop table #SNTempTable;

CREATE TABLE #SNTempTable
(
    SN VARCHAR(999)
)

if(@OPNO != @FINALPROCESS)
begin
insert into #SNTempTable
SELECT DISTINCT SNNO
FROM TBLCUSSNCHANGERECORD a
WHERE (EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 1
			AND a.SNNO = SNNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
		)
	AND NOT EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 0
			AND a.SNNO = SNNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
		)
	)
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
	end
	else
	begin
	insert into #SNTempTable
SELECT DISTINCT SNNO
FROM TBLCUSSNCHANGERECORD a
WHERE (EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 11
			AND a.SNNO = SNNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
		)
	AND NOT EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 0
			AND a.SNNO = SNNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
		)
	)
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
	end

DECLARE @fm DECIMAL = convert(DECIMAL, (
			SELECT count(*)
			FROM (
				SELECT DISTINCT SNNO
				FROM TBLCUSSNCHANGERECORD
				WHERE OPNO = @OPNO
					AND STATE = 0
					AND PRODUCTNO = @PRODUCTNO

AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))

				) AS TEMP
			))
IF @fm > 0 AND @OPNO != @FINALPROCESS
BEGIN
	SELECT (
			(convert(DECIMAL, (
					SELECT count(*)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE OPNO = @OPNO
							AND STATE = 1
							AND PRODUCTNO = @PRODUCTNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))

						) AS TEMP
					))+ convert(decimal,(select count(1) from #SNTempTable))) / (convert(DECIMAL, (
					SELECT count(*)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE OPNO = @OPNO
							AND STATE = 0
							AND PRODUCTNO = @PRODUCTNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
						) AS TEMP
					)) + convert(decimal,(select count(1) from #SNTempTable)))
			) AS result
		,(
			SELECT MAX(CREATEDATE)
			FROM TBLCUSSNCHANGERECORD
			WHERE STATE = 1
				AND PRODUCTNO = @PRODUCTNO
				AND OPNO = @OPNO
			) AS createTime
END
ELSE  if @fm > 0
BEGIN
	SELECT (
			(convert(DECIMAL, (
					SELECT COUNT(*)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE STATE = 11
							AND PRODUCTNO = @PRODUCTNO
							AND OPNO = @OPNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
						) AS TEMP
					))+ convert(decimal,(select count(1) from #SNTempTable))) / (convert(DECIMAL, (
					SELECT COUNT(snno)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE PRODUCTNO = @PRODUCTNO and OPNO = @OPNO and STATE = 0
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
						) AS TEMP
					)) + convert(decimal,(select count(1) from #SNTempTable)))
			) AS result
		,(
			SELECT MAX(CREATEDATE)
			FROM TBLCUSSNCHANGERECORD
			WHERE STATE = 11
				AND PRODUCTNO = @PRODUCTNO
				AND OPNO = @OPNO
AND CREATEDATE < GETDATE()
AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
				) AS createTime
END
```