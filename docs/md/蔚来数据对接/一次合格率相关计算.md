### 工位一次合格率
```sql
--DECLARE @PRODUCTNO NVARCHAR(999) = '{procedureList.Rows[j][0]}'
--DECLARE @OPNO NVARCHAR(999) = '{procedureList.Rows[j][1]}'

DECLARE @PRODUCTNO NVARCHAR(999) = '11.YC01.P0235220'
DECLARE @OPNO NVARCHAR(999) = 'GP12'

--select * from TBLCUSSNCHANGERECORD where PRODUCTNO = '11.YC01.P0235220' order by CREATEDATE desc

--'2023-09-15 00:00:00.000'
--'2023-09-15 08:28:29.677'

--AND CREATEDATE < '2023-09-15 08:28:29.677'
--AND CREATEDATE > '2023-09-15 00:00:00.000'

--统计在今天出站但不是今天入站的sn

if(OBJECT_ID('tempdb..#SNTempTable')) is not null
drop table #SNTempTable;

CREATE TABLE #SNTempTable
(
    SN VARCHAR(999)
)

if(@OPNO != 'GP12')
begin
insert into #SNTempTable
SELECT DISTINCT SNNO
FROM TBLCUSSNCHANGERECORD a
WHERE (EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 1
			AND a.SNNO = SNNO
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
		)
	AND NOT EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 0
			AND a.SNNO = SNNO
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
		)
	)
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
	end
	else
	begin
	insert into #SNTempTable
SELECT DISTINCT SNNO
FROM TBLCUSSNCHANGERECORD a
WHERE (EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 11
			AND a.SNNO = SNNO
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
		)
	AND NOT EXISTS (
		SELECT snno
		FROM TBLCUSSNCHANGERECORD
		WHERE OPNO = @OPNO
			AND STATE = 0
			AND a.SNNO = SNNO
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
		)
	)
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
	end

DECLARE @fm DECIMAL = convert(DECIMAL, (
			SELECT count(*)
			FROM (
				SELECT DISTINCT SNNO
				FROM TBLCUSSNCHANGERECORD
				WHERE OPNO = @OPNO
					AND STATE = 0
					AND PRODUCTNO = @PRODUCTNO

					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'

				) AS TEMP
			))

IF @fm > 0 AND @OPNO != 'GP12'
BEGIN
	SELECT (
			(convert(DECIMAL, (
					SELECT count(*)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE OPNO = @OPNO
							AND STATE = 1
							AND PRODUCTNO = @PRODUCTNO

					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'

						) AS TEMP
					))+ convert(decimal,(select count(1) from #SNTempTable))) / (convert(DECIMAL, (
					SELECT count(*)
					FROM (

						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE OPNO = @OPNO
							AND STATE = 0
							AND PRODUCTNO = @PRODUCTNO

					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'

						) AS TEMP

					)) + convert(decimal,(select count(1) from #SNTempTable)))
			) AS result
		,(
			SELECT MAX(CREATEDATE)
			FROM TBLCUSSNCHANGERECORD
			WHERE STATE = 1
				AND PRODUCTNO = @PRODUCTNO
				AND OPNO = @OPNO
			) AS createTime
END
ELSE  if @fm > 0
BEGIN
	SELECT (
			(convert(DECIMAL, (
					SELECT COUNT(*)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE STATE = 11
							AND PRODUCTNO = @PRODUCTNO
							AND OPNO = @OPNO

					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
						) AS TEMP
					))+ convert(decimal,(select count(1) from #SNTempTable))) / (convert(DECIMAL, (
					SELECT COUNT(snno)
					FROM (
						SELECT DISTINCT SNNO
						FROM TBLCUSSNCHANGERECORD
						WHERE PRODUCTNO = @PRODUCTNO and OPNO = @OPNO and STATE = 0

					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'

						) AS TEMP
					)) + convert(decimal,(select count(1) from #SNTempTable)))
			) AS result
		,(
			SELECT MAX(CREATEDATE)
			FROM TBLCUSSNCHANGERECORD
			WHERE STATE = 11
				AND PRODUCTNO = @PRODUCTNO
				AND OPNO = @OPNO
					AND CREATEDATE < '2023-05-15 23:59:59.000'
					AND CREATEDATE > '2023-05-15 00:00:00.000'
				) AS createTime
END

--select count(distinct SNNO) from TBLCUSSNCHANGERECORD where PRODUCTNO = '11.YC01.P0235220' 
--					AND CREATEDATE < '2023-05-15 23:59:59.000'
--					AND CREATEDATE > '2023-05-15 00:00:00.000' and OPNO = 'GP12' and state = 0

					--AND CREATEDATE < '2023-05-15 24:00:00.000'
					--AND CREATEDATE > '2023-05-15 00:00:00.000'

--AND CREATEDATE < GETDATE()
--AND CREATEDATE > (select cast((cast(GETDATE() AS DATE)) AS DATETIME))
```